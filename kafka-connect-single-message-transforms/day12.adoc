= Twelve Days of Single Message Transforms - Day 12 - `kafka-connect-transform-common`
Robin Moffatt <robin@confluent.io>
v0.01, 23 December 2020

< TODO >

== 🎥 Recording

image::https://img.youtube.com/vi/TODO/maxresdefault.jpg[link=https://youtu.be/TODO]

== Setup

1. Clone the repository 
+
[source,bash]
----
git clone https://github.com/confluentinc/demo-scene.git
cd demo-scene/kafka-connect-single-message-transforms
----

2. Bring the stack up
+
[source,bash]
----
docker-compose up -d
----

3. Wait for Kafka Connect to start up
+
[source,bash]
----
bash -c ' \
echo -e "\n\n=============\nWaiting for Kafka Connect to start listening on localhost ⏳\n=============\n"
while [ $(curl -s -o /dev/null -w %{http_code} http://localhost:8083/connectors) -ne 200 ] ; do
  echo -e "\t" $(date) " Kafka Connect listener HTTP state: " $(curl -s -o /dev/null -w %{http_code} http://localhost:8083/connectors) " (waiting for 200)"
  sleep 5
done
echo -e $(date) "\n\n--------------\n\o/ Kafka Connect is ready! Listener HTTP state: " $(curl -s -o /dev/null -w %{http_code} http://localhost:8083/connectors) "\n--------------\n"
'
----

=== Generate test data

[source,javascript]
----
curl -i -X PUT -H  "Content-Type:application/json" \
    http://localhost:8083/connectors/source-voluble-datagen-day12-00/config \
    -d '{
        "connector.class"                 : "io.mdrogalis.voluble.VolubleSourceConnector",
        "genkp.day12-sys01.with"          : "#{Internet.uuid}",
        "genv.day12-sys01.amount.with"    : "#{Commerce.price}",
        "genv.day12-sys01.units.with"     : "#{number.number_between '\''1'\'','\''99'\''}",
        "genv.day12-sys01.txn_date.with"  : "#{date.past '\''10'\'','\''DAYS'\''}",
        "genv.day12-sys01.product.with"   : "#{Beer.name}",
        "genv.day12-sys01.source.with"    : "SYS01",
        "topic.day12-sys01.throttle.ms"   : 1000
    }'
----


== Change the topic case

curl -i -X PUT -H "Accept:application/json" \
  -H  "Content-Type:application/json" http://localhost:8083/connectors/sink-jdbc-mysql-day12-00/config \
  -d '{
      "connector.class"                        : "io.confluent.connect.jdbc.JdbcSinkConnector",
      "connection.url"                         : "jdbc:mysql://mysql:3306/demo",
      "connection.user"                        : "mysqluser",
      "connection.password"                    : "mysqlpw",
      "topics"                                 : "day12-sys01",
      "tasks.max"                              : "4",
      "auto.create"                            : "true",
      "auto.evolve"                            : "true",
      
      "transforms"                             : "topicCase",
      "transforms.topicCase.type"            : "com.github.jcustenborder.kafka.connect.transform.common.ChangeTopicCase",
      "transforms.topicCase.from": "LOWER_HYPHEN",
      "transforms.topicCase.to": "UPPER_CAMEL"
      }'

mysql> show tables;
+----------------+
| Tables_in_demo |
+----------------+
| Day12Sys01     |

== Use the timestamp of a field as the message timestamp

curl -i -X PUT -H "Accept:application/json" \
  -H  "Content-Type:application/json" http://localhost:8083/connectors/sink-jdbc-mysql-day12-01/config \
  -d '{
      "connector.class"                        : "io.confluent.connect.jdbc.JdbcSinkConnector",
      "connection.url"                         : "jdbc:mysql://mysql:3306/demo",
      "connection.user"                        : "mysqluser",
      "connection.password"                    : "mysqlpw",
      "topics"                                 : "day12-sys01",
      "tasks.max"                              : "4",
      "auto.create"                            : "true",
      "auto.evolve"                            : "true",
      
      "transforms"                              : "convertTS,extractTS,setTopicName",
      "transforms.convertTS.type"               : "org.apache.kafka.connect.transforms.TimestampConverter$Value",
      "transforms.convertTS.field"              : "txn_date",
      "transforms.convertTS.format"             : "EEE MMM dd HH:mm:ss zzz yyyy",
      "transforms.convertTS.target.type"        : "Timestamp",
      "transforms.extractTS.type"               : "com.github.jcustenborder.kafka.connect.transform.common.ExtractTimestamp$Value",
      "transforms.extractTS.field.name"         : "txn_date",
      "transforms.setTopicName.type"            : "org.apache.kafka.connect.transforms.TimestampRouter",
      "transforms.setTopicName.topic.format"    : "${topic}_${timestamp}",
      "transforms.setTopicName.timestamp.format": "YYYY-MM-dd"
      }'

mysql> show tables;
+------------------------+
| Tables_in_demo         |
+------------------------+
| day12-sys01_2020-12-07 |
| day12-sys01_2020-12-08 |
| day12-sys01_2020-12-09 |
| day12-sys01_2020-12-10 |
| day12-sys01_2020-12-11 |
| day12-sys01_2020-12-12 |
| day12-sys01_2020-12-13 |
| day12-sys01_2020-12-14 |
| day12-sys01_2020-12-15 |
| day12-sys01_2020-12-16 |
+------------------------+
12 rows in set (0.01 sec)      

== Add the current timestamp to the message payload

curl -i -X PUT -H "Accept:application/json" \
  -H  "Content-Type:application/json" http://localhost:8083/connectors/sink-jdbc-mysql-day12-02/config \
  -d '{
      "connector.class"          : "io.confluent.connect.jdbc.JdbcSinkConnector",
      "connection.url"           : "jdbc:mysql://mysql:3306/demo",
      "connection.user"          : "mysqluser",
      "connection.password"      : "mysqlpw",
      "topics"                   : "day12-sys01",
      "tasks.max"                : "4",
      "auto.create"              : "true",
      "auto.evolve"              : "true",
      
      "transforms"                : "addTSNow",
      "transforms.addTSNow.type"  : "com.github.jcustenborder.kafka.connect.transform.common.TimestampNowField$Value",
      "transforms.addTSNow.fields": "processingTS"
      }'

mysql> select product, amount, txn_date, processingTS from `day12-sys01` ORDER BY units  LIMIT 5;
+------------------------------+--------+------------------------------+-------------------------+
| product                      | amount | txn_date                     | processingTS            |
+------------------------------+--------+------------------------------+-------------------------+
| Sublimely Self-Righteous Ale | 61.25  | Mon Dec 14 09:12:03 GMT 2020 | 2020-12-17 00:43:02.550 |
| Arrogant Bastard Ale         | 88.65  | Wed Dec 09 18:05:02 GMT 2020 | 2020-12-17 00:43:02.559 |
| Sublimely Self-Righteous Ale | 30.81  | Fri Dec 11 14:49:14 GMT 2020 | 2020-12-17 00:43:02.551 |
| Arrogant Bastard Ale         | 20.45  | Tue Dec 08 10:30:21 GMT 2020 | 2020-12-17 00:43:02.223 |
| Sublimely Self-Righteous Ale | 56.95  | Wed Dec 16 23:12:23 GMT 2020 | 2020-12-17 00:43:02.233 |
+------------------------------+--------+------------------------------+-------------------------+
5 rows in set (0.00 sec)      

== Using `SimulatorSinkConnector` 

curl -i -X PUT -H  "Content-Type:application/json" \
    http://localhost:8083/connectors/sink-simulator-day12-02/config \
    -d '{
        "connector.class"           : "com.github.jcustenborder.kafka.connect.simulator.SimulatorSinkConnector",
        "topics"                    : "day12-sys01",
        "log.entries"               : "true",
        "transforms"                : "addTSNow",
        "transforms.addTSNow.type"  : "com.github.jcustenborder.kafka.connect.transform.common.TimestampNowField$Value",
        "transforms.addTSNow.fields": "processingTS"
    }'