Download & build the plugin

[source,bash]
----
git clone https://github.com/llofberg/kafka-connect-rest.git
cd kafka-connect-rest
mvn clean package
mkdir -p ../data/connectors
cp kafka-connect-rest-plugin/target/kafka-connect-rest-plugin-*-shaded.jar ../data/connectors/ && \
cp kafka-connect-transform-from-json/kafka-connect-transform-from-json-plugin/target/kafka-connect-transform-from-json-plugin-*-shaded.jar ../data/connectors/ && \
cp kafka-connect-transform-add-headers/target/kafka-connect-transform-add-headers-*-shaded.jar ../data/connectors/ && \
cp kafka-connect-transform-velocity-eval/target/kafka-connect-transform-velocity-eval-*-shaded.jar ../data/connectors/
----

Start the stack

[source,bash]
----
docker-compose up -d
----

Check connector has been loaded 

[source,bash]
----
➜ curl -s localhost:8083/connector-plugins|jq '.[].class'|egrep 'com.tm.kafka.connect.rest.RestSourceConnector'

"com.tm.kafka.connect.rest.RestSourceConnector"
----

Create the source connector

[source,javascript]
----

curl -i -X PUT -H "Accept:application/json" \
          -H  "Content-Type:application/json" http://localhost:8083/connectors/source-rest-carpark-01/config \
          -d '{
      "connector.class": "com.tm.kafka.connect.rest.RestSourceConnector",
      "key.converter":"org.apache.kafka.connect.storage.StringConverter",
      "value.converter":"org.apache.kafka.connect.storage.StringConverter",
      "tasks.max": "1",
      "rest.source.poll.interval.ms": "300000",
      "rest.source.method": "GET",
      "rest.source.url": "https://datahub.bradford.gov.uk/ebase/api/getData/v2/Council/CarParkCurrent",
      "rest.source.payload.converter.class": "com.tm.kafka.connect.rest.converter.StringPayloadConverter",
      "rest.source.topic.selector": "com.tm.kafka.connect.rest.selector.SimpleTopicSelector",
      "rest.source.destination.topics": "carpark-bradford"
      }'
----

[source,sql]
----


ksql> show topics;

 Kafka Topic      | Partitions | Partition Replicas
----------------------------------------------------
 carpark-bradford | 1          | 1
----------------------------------------------------
ksql> print 'carpark-bradford' from beginning;
Key format: ¯\_(ツ)_/¯ - no data processed
Value format: KAFKA_STRING
rowtime: 2020/07/20 15:10:57.411 Z, key: <null>, value: date,time,name,capacity,empty_places,status,latitude,longitude,directionsURL
2020-07-20,16:03,Westgate,116,80,Spaces,53.796291,-1.759143,"https://maps.google.com/?daddr=53.796291,-1.759143"
2020-07-20,16:03,Burnett St,122,108,Spaces,53.795739,-1.744756,"https://maps.google.com/?daddr=53.795739,-1.744756"
2020-07-20,16:03,Crown Court,142,112,Spaces,53.792179,-1.748466,"https://maps.google.com/?daddr=53.792179,-1.748466"
2020-07-20,16:03,Leisure Exchange,996,951,Spaces,53.79222,-1.746683,"https://maps.google.com/?daddr=53.79222,-1.746683"
2020-07-20,16:03,NCP Hall Ings,526,511,Spaces,53.791838,-1.752201,"https://maps.google.com/?daddr=53.791838,-1.752201"
2020-07-20,16:03,Broadway,1181,982,Spaces,53.794175,-1.750107,"https://maps.google.com/?daddr=53.794175,-1.750107"
2020-07-20,16:03,Kirkgate Centre,611,487,Spaces,53.795002,-1.755938,"https://maps.google.com/?daddr=53.795002,-1.755938"
2020-07-20,16:03,Sharpe Street,98,75,Spaces,53.789785,-1.756187,"https://maps.google.com/?daddr=53.789785,-1.756187"
----

Note that single row has all messages, which makes it more difficult to work with. Instead, let's use `kafkacat`: 

[source,bash]
----
while [ 1 -eq 1 ];
do 
    curl -s https://datahub.bradford.gov.uk/ebase/api/getData/v2/Council/CarParkCurrent | \
        tail -n +2 | \
        docker exec -i kafkacat kafkacat -b broker:29092 -t carparks -P -T
    sleep 180
done
----

Now we have each record in its own message

[source,bash]
----
ksql> PRINT carparks FROM BEGINNING;
Key format: ¯\_(ツ)_/¯ - no data processed
Value format: KAFKA_STRING
rowtime: 2020/07/20 15:39:21.145 Z, key: <null>, value: 2020-07-20,16:33,Westgate,116,92,Spaces,53.796291,-1.759143,"https://maps.google.com/?daddr=53.796291,-1.759143"
rowtime: 2020/07/20 15:39:21.145 Z, key: <null>, value: 2020-07-20,16:33,Burnett St,122,114,Spaces,53.795739,-1.744756,"https://maps.google.com/?daddr=53.795739,-1.744756"
rowtime: 2020/07/20 15:39:21.145 Z, key: <null>, value: 2020-07-20,16:33,Crown Court,142,121,Spaces,53.792179,-1.748466,"https://maps.google.com/?daddr=53.792179,-1.748466"
rowtime: 2020/07/20 15:39:21.145 Z, key: <null>, value: 2020-07-20,16:33,Leisure Exchange,996,966,Spaces,53.79222,-1.746683,"https://maps.google.com/?daddr=53.79222,-1.746683"
rowtime: 2020/07/20 15:39:21.145 Z, key: <null>, value: 2020-07-20,16:33,NCP Hall Ings,526,516,Spaces,53.791838,-1.752201,"https://maps.google.com/?daddr=53.791838,-1.752201"
rowtime: 2020/07/20 15:39:21.145 Z, key: <null>, value: 2020-07-20,16:33,Broadway,1190,1009,Spaces,53.794175,-1.750107,"https://maps.google.com/?daddr=53.794175,-1.750107"
rowtime: 2020/07/20 15:39:21.145 Z, key: <null>, value: 2020-07-20,16:33,Kirkgate Centre,611,516,Spaces,53.795002,-1.755938,"https://maps.google.com/?daddr=53.795002,-1.755938"
rowtime: 2020/07/20 15:39:21.148 Z, key: <null>, value: 2020-07-20,16:33,Sharpe Street,98,77,Spaces,53.789785,-1.756187,"https://maps.google.com/?daddr=53.789785,-1.756187"
----

Let's apply a schema

[source,bash]
----
curl -s https://datahub.bradford.gov.uk/ebase/api/getData/v2/Council/CarParkCurrent | head -n 1
date,time,name,capacity,empty_places,status,latitude,longitude,directionsURL
----



[source,sql]
----
CREATE STREAM CARPARK_SRC (date          VARCHAR ,
                           time          VARCHAR ,
                           name          VARCHAR ,
                           capacity      INT ,
                           empty_places  INT ,
                           status        VARCHAR ,
                           latitude      VARCHAR ,
                           longitude     VARCHAR ,
                           directionsURL VARCHAR)
                WITH (KAFKA_TOPIC='carparks', 
                VALUE_FORMAT='DELIMITED');

-- https://github.com/confluentinc/ksql/issues/3950
CREATE STREAM CARPARK_EVENTS WITH (VALUE_FORMAT='PROTOBUF', PARTITIONS=4) AS SELECT 1 AS DUMMY, STRINGTOTIMESTAMP(DATE + ' ' + TIME ,'yyyy-MM-dd HH:mm','Europe/London' ) AS TS,* FROM CARPARK_SRC EMIT CHANGES;
----

[source,sql]
----
CREATE TABLE CARPARK AS
SELECT NAME, 
       TIMESTAMPTOSTRING( LATEST_BY_OFFSET(TS),'yyyy-MM-dd HH:mm:ss','Europe/London') AS LATEST_TS, 
       LATEST_BY_OFFSET(CAPACITY) AS CAPACITY,
       LATEST_BY_OFFSET(EMPTY_PLACES) AS CURRENT_EMPTY_PLACES,
       MIN(EMPTY_PLACES) AS MIN_EMPTY_PLACES,
       MAX(EMPTY_PLACES) AS MAX_EMPTY_PLACES,
       (CAST(LATEST_BY_OFFSET(CAPACITY) - LATEST_BY_OFFSET(EMPTY_PLACES) AS DOUBLE) / 
        CAST(LATEST_BY_OFFSET(CAPACITY) AS DOUBLE)) * 100 AS PCT_FULL,
       LATEST_BY_OFFSET(STATUS) AS STATUS,
       LATEST_BY_OFFSET(LATITUDE) AS LATITUDE,
       LATEST_BY_OFFSET(LONGITUDE) AS LONGITUDE,
       LATEST_BY_OFFSET(DIRECTIONSURL) AS DIRECTIONSURL
    FROM CARPARK_EVENTS
    GROUP BY NAME;
----

== Push and pull queries

=== Pull (k/v lookup): How many spaces are currently free?

[source,sql]
----
ksql> SELECT CURRENT_EMPTY_PLACES, PCT_FULL FROM CARPARK WHERE NAME='Westgate';
+----------------------+--------------------+
|CURRENT_EMPTY_PLACES  |PCT_FULL            |
+----------------------+--------------------+
|111                   |4.310344827586207   |
----

* `/query`
+
[source,bash]
----
curl --silent --location --request POST 'http://localhost:8088/query' \
--header 'Content-Type: application/vnd.ksql.v1+json; charset=utf-8' \
--data-raw '{
    "ksql": "SELECT CURRENT_EMPTY_PLACES, PCT_FULL FROM CARPARK4 WHERE NAME='\''Westgate'\'';"
}' | jq '.'
----
+
[source,javascript]
----
[
  {
    "header": {
      "queryId": "query_1595341978539",
      "schema": "`CURRENT_EMPTY_PLACES` INTEGER, `PCT_FULL` DOUBLE"
    }
  },
  {
    "row": {
      "columns": [
        88,
        24.137931034482758
      ]
    }
  }
]
----

* `/query-stream`
+
[source,bash]
----
curl --silent --http2 --location --request POST 'http://localhost:8088/query-stream' \
--header 'Content-Type: application/vnd.ksql.v1+json; charset=utf-8' --header 'Accept: application/json' \
--data-raw '{"sql":"SELECT CURRENT_EMPTY_PLACES, PCT_FULL FROM CARPARK4 WHERE NAME='\''Westgate'\'';"}' | jq '.'
----
+
[source,javascript]
----
[
  {
    "queryId": null,
    "columnNames": [
      "CURRENT_EMPTY_PLACES",
      "PCT_FULL"
    ],
    "columnTypes": [
      "INTEGER",
      "DOUBLE"
    ]
  },
  [
    86,
    25.862068965517242
  ]
]
----



=== Push (Event-driven alert): Tell me when there's a space available

[source,sql]
----
SELECT NAME AS CARPARK,
      TIMESTAMPTOSTRING(TS,'yyyy-MM-dd HH:mm:ss','Europe/London') AS DATA_TS,
      CAPACITY     ,
      EMPTY_PLACES
 FROM CARPARK_EVENTS 
 WHERE NAME = 'Kirkgate Centre' 
   AND EMPTY_PLACES > 0 
 EMIT CHANGES;
----

* `/query`
+
[source,bash]
----
curl --location --request POST 'http://localhost:8088/query' \
--header 'Content-Type: application/vnd.ksql.v1+json; charset=utf-8' \
--data-raw '{
    "ksql": "SELECT NAME AS CARPARK,      TIMESTAMPTOSTRING(TS,'\''yyyy-MM-dd HH:mm:ss'\'','\''Europe/London'\'') AS DATA_TS,      CAPACITY     ,      EMPTY_PLACES FROM CARPARK_EVENTS  WHERE NAME = '\''Kirkgate Centre'\''    AND EMPTY_PLACES > 0  EMIT CHANGES;"
}'
----
+
[source,bash]
----
[{"header":{"queryId":"none","schema":"`CARPARK` STRING, `DATA_TS` STRING, `CAPACITY` INTEGER, `EMPTY_PLACES` INTEGER"}},
{"row":{"columns":["Kirkgate Centre","2020-07-21 15:10:00",611,462]}},
----

* `/query-stream`
+
[source,bash]
----
curl --http2 --location --request POST 'http://localhost:8088//query-stream' \
--header 'Content-Type: application/vnd.ksql.v1+json; charset=utf-8' \
--data-raw '{
    "sql": "SELECT NAME AS CARPARK,      TIMESTAMPTOSTRING(TS,'\''yyyy-MM-dd HH:mm:ss'\'','\''Europe/London'\'') AS DATA_TS,      CAPACITY     ,      EMPTY_PLACES FROM CARPARK_EVENTS  WHERE NAME = '\''Kirkgate Centre'\''    AND EMPTY_PLACES > 0  EMIT CHANGES;"
}'
----
+
[source,bash]
----
{"queryId":"72e17319-f7e0-4d38-872e-5b15490aba45","columnNames":["CARPARK","DATA_TS","CAPACITY","EMPTY_PLACES"],"columnTypes":["STRING","STRING","INTEGER","INTEGER"]}
["Kirkgate Centre","2020-07-21 16:16:00",611,468]
----





[source,sql]
----
CREATE TABLE ALERT_CONFIG (CARPARK VARCHAR PRIMARY KEY, SPACES_ALERT INT) WITH (KAFKA_TOPIC='alert_config', VALUE_FORMAT='PROTOBUF', PARTITIONS=4);

INSERT INTO ALERT_CONFIG (CARPARK, SPACES_ALERT) VALUES ('Kirkgate Centre',470);

CREATE STREAM CARPARK_ALERTS AS
    SELECT C.NAME AS CARPARK, 
           TIMESTAMPTOSTRING(C.TS,'yyyy-MM-dd HH:mm:ss','Europe/London') AS DATA_TS, 
           CAPACITY     ,
           EMPTY_PLACES,
           A.SPACES_ALERT AS ALERT_THRESHOLD, 
           STATUS      ,
           LATITUDE    ,
           LONGITUDE   ,
           DIRECTIONSURL
      FROM CARPARK_EVENTS C
            INNER JOIN 
           ALERT_CONFIG A
            ON C.NAME=A.CARPARK
      WHERE C.EMPTY_PLACES >= A.SPACES_ALERT ;
----

[source,sql]
----
SELECT CARPARK, ALERT_THRESHOLD, DATA_TS, EMPTY_PLACES FROM CARPARK_ALERTS EMIT CHANGES;
+-----------------+-----------------+--------------------+-------------+
|CARPARK          |ALERT_THRESHOLD  |DATA_TS             |EMPTY_PLACES |
+-----------------+-----------------+--------------------+-------------+
|Kirkgate Centre  |470              |2020-07-21 10:55:00 |505          |
----



== ksqlDB Pull and Push queries with REST API

=== `curl`



== Cool stuff if you have the user's location

Track user location

[source,sql]
----
CREATE STREAM USER_TRACKING (USERNAME VARCHAR KEY , LAT DOUBLE, LON DOUBLE, DUMMY INT) WITH (KAFKA_TOPIC='user_loc', VALUE_FORMAT='PROTOBUF', PARTITIONS=4);

INSERT INTO USER_TRACKING (USERNAME, LAT, LON, DUMMY) VALUES ('Robin', 53.790566, -1.759100,1);
INSERT INTO USER_TRACKING (USERNAME, LAT, LON, DUMMY) VALUES ('Robin', 53.790389, -1.759765,1);
INSERT INTO USER_TRACKING (USERNAME, LAT, LON, DUMMY) VALUES ('Robin', 53.789590, -1.761407,1);
INSERT INTO USER_TRACKING (USERNAME, LAT, LON, DUMMY) VALUES ('Robin', 53.788468, -1.763703,1);

CREATE TABLE USER_LOCATION AS SELECT USERNAME, LATEST_BY_OFFSET(LAT) AS LAT, LATEST_BY_OFFSET(LON) AS LON, TIMESTAMPTOSTRING(MAX(ROWTIME),'yyyy-MM-dd HH:mm:ss','Europe/London') AS LATEST_TS, COUNT(*) AS MOVEMENT_CT  FROM USER_TRACKING GROUP BY USERNAME;
----

[source,sql]
----
ksql> SELECT USERNAME, LAT, LON FROM USER_LOCATION WHERE USERNAME='Robin';
+-----------+-----------+-----------+
|USERNAME   |LAT        |LON        |
+-----------+-----------+-----------+
|Robin      |53.788468  |-1.763703  |
----

This next bit is a bit of a half-way house. We can use `GEO_DISTANCE` to get the distance (as the crow flies) between two points, but it's not possible to do a non-key join between two tables (current user position and current car park state). Instead we do a cartesian stream-stream join on the underlying events with a window of 10 minutes (the assumption being if the data is any older on either side then it can't be treated as current). 

[source,sql]
----
CREATE TABLE NEAREST_CARPARK AS 
SELECT USERNAME AS KEY1, NAME AS KEY2, 
       AS_VALUE(USERNAME) AS USERNAME, 
       AS_VALUE(NAME) AS CARPARK, 
       TIMESTAMPTOSTRING( LATEST_BY_OFFSET(C.TS),'yyyy-MM-dd HH:mm:ss','Europe/London') AS DATA_TS, 
       GEO_DISTANCE(CAST(LATEST_BY_OFFSET(C.LATITUDE) AS DOUBLE),
                    CAST(LATEST_BY_OFFSET(C.LONGITUDE) AS DOUBLE),
                    LATEST_BY_OFFSET(U.LAT),
                    LATEST_BY_OFFSET(U.LON)) AS DISTANCE_TO_CARPARK_KM,
        LATEST_BY_OFFSET(EMPTY_PLACES) AS CURRENT_EMPTY_PLACES,
       (CAST(LATEST_BY_OFFSET(CAPACITY) - LATEST_BY_OFFSET(EMPTY_PLACES) AS DOUBLE) / 
        CAST(LATEST_BY_OFFSET(CAPACITY) AS DOUBLE)) * 100 AS PCT_FULL,
       LATEST_BY_OFFSET(DIRECTIONSURL) AS DIRECTIONSURL                    
  FROM CARPARK_EVENTS C 
        INNER JOIN 
       USER_TRACKING U 
       WITHIN 10 MINUTES ON C.DUMMY=U.DUMMY 
GROUP BY USERNAME, NAME
EMIT CHANGES;
----

This results in a table which gets us most of the way there - given the user's current position, how far are they from each car park that has empty spaces? From this table the client would need to apply a function to return the closest car park (since ksqlDB doesn't yet have a TopN function, or `ORDER BY…LIMIT 1`).

[source,sql]
----
ksql> SELECT USERNAME, 
             CARPARK, 
             DISTANCE_TO_CARPARK_KM,
             CURRENT_EMPTY_PLACES, 
             PCT_FULL,
             DIRECTIONSURL 
        FROM NEAREST_CARPARK 
        WHERE CURRENT_EMPTY_PLACES>0
        EMIT CHANGES;
+----------+-----------------+-----------------------+----------------------+-------+----------------------------+
|USERNAME  |CARPARK          |DISTANCE_TO_CARPARK_KM |CURRENT_EMPTY_PLACES  |PCT_FU |DIRECTIONSURL               |
+----------+-----------------+-----------------------+----------------------+-------+----------------------------+
|Robin     |NCP Hall Ings    |0.6543405759178128     |506                   |3.8022 |https://maps.google.com/?dad|
|          |                 |                       |                      |       |dr=53.791838,-1.752201      |
|Robin     |Crown Court      |0.8974759769914396     |89                    |37.323 |https://maps.google.com/?dad|
|          |                 |                       |                      |       |dr=53.792179,-1.748466      |
|Robin     |Sharpe Street    |0.34357886788866193    |70                    |28.571 |https://maps.google.com/?dad|
|          |                 |                       |                      |       |dr=53.789785,-1.756187      |
|Robin     |Leisure Exchange |1.0104154810532562     |944                   |5.2208 |https://maps.google.com/?dad|
|          |                 |                       |                      |       |dr=53.79222,-1.746683       |
|Robin     |Westgate         |0.7598114828203173     |79                    |31.896 |https://maps.google.com/?dad|
|          |                 |                       |                      |       |dr=53.796291,-1.759143      |
|Robin     |Burnett St       |1.2898373463967188     |110                   |9.8360 |https://maps.google.com/?dad|
|          |                 |                       |                      |       |dr=53.795739,-1.744756      |
|Robin     |Broadway         |0.9004706574553182     |948                   |19.524 |https://maps.google.com/?dad|
|          |                 |                       |                      |       |dr=53.794175,-1.750107      |
|Robin     |Kirkgate Centre  |0.7008511543305518     |490                   |19.803 |https://maps.google.com/?dad|
|          |                 |                       |                      |       |dr=53.795002,-1.755938      |
----
