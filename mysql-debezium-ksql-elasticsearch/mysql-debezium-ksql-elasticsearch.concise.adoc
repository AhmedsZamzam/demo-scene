[source,bash]
----
mysql demo -uroot < ~/git/demo-scene/mysql-debezium-ksql-elasticsearch/customers.sql
----

[source,bash]
----
confluent start
----

[source,bash]
----
screen -d -m -S CP_demo -t bash watch date
screen -S CP_demo -p 0 -X screen -t Elasticsearch elasticsearch
screen -S CP_demo -p 0 -X screen -t Kibana kibana
screen -S CP_demo -p 0 -X screen -t mysql mysql -uroot demo
screen -S CP_demo -p 0 -X screen -t ksql ksql
screen -S CP_demo -p 0 -X screen -t datagen ksql-datagen quickstart=ratings format=avro topic=ratings maxInterval=500
----

[source,bash]
----
~/git/demo-scene/mysql-debezium-ksql-elasticsearch/add-es-connector.sh
~/git/demo-scene/mysql-debezium-ksql-elasticsearch/add-debezium-connector.sh
----


== Pre-flight checklist

Is the stack up?

[source,bash]
----
Robin@asgard02 ~> confluent status
control-center is [UP]
ksql-server is [UP]
connect is [UP]
kafka-rest is [UP]
schema-registry is [UP]
kafka is [UP]
zookeeper is [UP]
Robin@asgard02 ~>
----

Are the connectors running?

[source,bash]
----
Robin@asgard02 ~> confluent status connectors|grep -v Writing| jq '.[]'|  xargs -I{connector} confluent status {connector}|  grep -v Writing| jq -c -M '[.name,.connector.state,.tasks[].state]|join(":|:")'|  column -s : -t|  sed 's/\"//g'|  sort
es_sink_RATINGS_ENRICHED        |  RUNNING  |  RUNNING
mysql-source-demo-customers      |  RUNNING  |  RUNNING
mysql-source-demo-customers-raw  |  RUNNING  |  RUNNING
----

Is ratings data being produced?

[source,bash]
----
Robin@asgard02 ~> kafka-avro-console-consumer \
                  --bootstrap-server localhost:9092 \
                  --property schema.registry.url=http://localhost:8081 \
                  --topic ratings
{"rating_id":{"long":2253},"user_id":{"int":14},"stars":{"int":4},"route_id":{"int":1955},"rating_time":{"long":1523986139221},"channel":{"string":"ios"},"message":{"string":"Exceeded all my expectations. Thank you !"}}
----

Is Elasticsearch running?

[source,bash]
----
Robin@asgard02 ~> curl http://localhost:9200
{
  "name" : "0-JgLQj",
  "cluster_name" : "elasticsearch_Robin",
  "cluster_uuid" : "XKkAsum3QL-ECyZlP8z-rA",
  "version" : {
    "number" : "6.2.3",
    "build_hash" : "c59ff00",
    "build_date" : "2018-03-13T10:06:29.741383Z",
    "build_snapshot" : false,
    "lucene_version" : "7.2.1",
    "minimum_wire_compatibility_version" : "5.6.0",
    "minimum_index_compatibility_version" : "5.0.0"
  },
  "tagline" : "You Know, for Search"
}
----

* Load Kibana : http://localhost:5601/app/kibana#/
* Create two iTerm windows, using the `screencapture` profile
* Load file:///Users/Robin/git/demo-scene/mysql-debezium-ksql-elasticsearch/mysql-debezium-ksql-elasticsearch.adoc into Chrome
* Close all other apps

== Demo

image:images/ksql-debezium-es.png[Kafka Connect / KSQL / Elasticsearch]

=== Inspect topics

[source,sql]
----
SHOW TOPICS;
----

=== Inspect ratings & define stream

[source,sql]
----
PRINT 'ratings';
CREATE STREAM RATINGS WITH (KAFKA_TOPIC='ratings',VALUE_FORMAT='AVRO');
----

=== Filter live stream of data

[source,sql]
----
SELECT STARS, CHANNEL, MESSAGE FROM RATINGS WHERE STARS=1;
----

=== Show MySQL table + contents

[source,sql]
----
show tables;
----

=== Check status of connectors

[source,bash]
----
confluent status connectors|grep -v Writing| jq '.[]'|  xargs -I{connector} confluent status {connector}|  grep -v Writing| jq -c -M '[.name,.connector.state,.tasks[].state]|join(":|:")'|  column -s : -t|  sed 's/\"//g'|  sort
mysql-source-demo-customers  |  RUNNING  |  RUNNING
mysql-source-demo-customers-raw  |  RUNNING  |  RUNNING
----

=== Show Kafka topic has been created & populated

[source,bash]
----
$ kafka-avro-console-consumer \
   --bootstrap-server localhost:9092 \
   --property schema.registry.url=http://localhost:8081 \
   --topic asgard.demo.customers --from-beginning | jq '.'
----

=== Show CDC in action

==== Insert a row in MySQL, observe it in Kafka

[source,sql]
----
insert into customers (id,first_name,last_name) values (42,'Rick','Astley');
----

==== Update a row in MySQL, observe it in Kafka

[source,sql]
----
update customers set first_name='Bob' where id=1;
----

Point out before/after records in `raw` stream

=== Inspect customers data
[source,sql]
----
PRINT 'asgard.demo.customers' FROM BEGINNING;

CREATE STREAM CUSTOMERS_SRC WITH (KAFKA_TOPIC='asgard.demo.customers', VALUE_FORMAT='AVRO');
SET 'auto.offset.reset' = 'earliest';
SELECT ID, FIRST_NAME, LAST_NAME FROM CUSTOMERS_SRC;
----

=== Re-key the customer data
[source,sql]
----
CREATE STREAM CUSTOMERS_SRC_REKEY AS SELECT * FROM CUSTOMERS_SRC PARTITION BY ID;
-- Wait for a moment here; if you run the CTAS _immediately_ after the CSAS it may fail
-- with error `Could not fetch the AVRO schema from schema registry. Subject not found.; error code: 40401`
CREATE TABLE CUSTOMERS WITH (KAFKA_TOPIC='CUSTOMERS_SRC_REKEY', VALUE_FORMAT ='AVRO', KEY='ID');
SELECT ID, FIRST_NAME, LAST_NAME, EMAIL, MESSAGESOURCE FROM CUSTOMERS;
----

=== Join live stream of ratings to customer data

[source,sql]
----
SELECT R.RATING_ID, R.CHANNEL, R.MESSAGE, \
C.ID, C.FIRST_NAME + ' ' + C.LAST_NAME \
FROM RATINGS R \
LEFT JOIN CUSTOMERS C \
ON R.USER_ID = C.ID \
WHERE C.FIRST_NAME IS NOT NULL;
----

Persist this stream of data

[source,sql]
----
CREATE STREAM RATINGS_ENRICHED WITH (PARTITIONS=1) AS SELECT R.RATING_ID, R.CHANNEL, R.STARS, R.MESSAGE, C.ID, C.FIRST_NAME + ' ' + C.LAST_NAME AS FULL_NAME FROM RATINGS R LEFT JOIN CUSTOMERS C ON R.USER_ID = C.ID WHERE C.FIRST_NAME IS NOT NULL ;
----

=== Examine changing reference data

[source,sql]
----
ksql> SELECT * FROM RATINGS_ENRICHED WHERE ID=2;
----

[source,sql]
----
mysql> UPDATE CUSTOMERS SET FIRST_NAME = 'Thomas', LAST_NAME ='Smith' WHERE ID=2;
----

Observe in the continuous KSQL query that the customer name has now changed.

== View in Elasticsearch and Kibana

image:images/es01.png[Kibana]
